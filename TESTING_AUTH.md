# Инструкция по тестированию исправления авторизации

## Что было исправлено
Теперь пользователи остаются авторизованными после закрытия и повторного открытия сайта.

## Как протестировать

### Базовый тест

1. **Откройте сайт** в браузере
2. **Зарегистрируйтесь** или **войдите** в систему
3. **Откройте консоль браузера** (F12 → Console)
4. Вы должны увидеть логи:
   ```
   [App] localStorage is available
   [AuthContext] Login attempt for: your@email.com
   [AuthContext] User found, logging in: your@email.com
   [AuthContext] User saved to localStorage
   [AuthContext] User subscription loaded
   ```
5. **Закройте вкладку** (или весь браузер)
6. **Откройте сайт снова**
7. Вы должны автоматически войти без повторной авторизации
8. В консоли должны появиться логи:
   ```
   [App] localStorage is available
   [App] Found saved user in localStorage
   [AuthContext] Checking saved user: exists
   [AuthContext] Restored user from localStorage: your@email.com
   [AuthContext] User verified in database: your@email.com
   [AuthContext] User subscription loaded
   ```

### Расширенный тест с debug утилитами

1. Откройте консоль браузера (F12)
2. Выполните команду:
   ```javascript
   debugAuth.checkStorage()
   ```
3. Вы должны увидеть информацию о текущем пользователе:
   ```
   ✅ User found in localStorage: {id: "...", email: "...", name: "..."}
   ```

### Тест очистки и повторного входа

1. В консоли выполните:
   ```javascript
   debugAuth.clearAuth()
   ```
2. Обновите страницу (F5)
3. Вы должны быть перенаправлены на страницу входа
4. Войдите снова
5. Закройте и откройте сайт - вы должны остаться авторизованными

## Проблемы и их решение

### Проблема: После закрытия сайта требуется повторный вход

**Решение:**
1. Откройте консоль (F12)
2. Выполните `debugAuth.checkStorage()`
3. Если пользователь есть:
   - Проверьте логи с префиксом `[AuthContext]`
   - Возможно, API сервер не отвечает
   - Проверьте Network вкладку в DevTools
4. Если пользователя нет:
   - Возможно, localStorage заблокирован браузером
   - Проверьте настройки приватности браузера
   - Попробуйте другой браузер

### Проблема: Ошибки в консоли при входе

**Проверьте:**
1. Работает ли backend сервер:
   ```bash
   cd server && node app.js
   ```
2. Доступен ли API endpoint:
   - Откройте Network вкладку в DevTools
   - Попробуйте войти
   - Проверьте статус запросов к `/api/users/...`

### Проблема: localStorage недоступен

**Возможные причины:**
1. Режим инкогнито/приватный просмотр
2. Блокировка cookies и storage в настройках браузера
3. Расширения браузера блокируют storage

**Решение:**
1. Используйте обычный режим браузера
2. Разрешите cookies для сайта
3. Отключите расширения, блокирующие storage

## Технические детали для разработчиков

### localStorage ключи
- `auth_user` - данные текущего пользователя (JSON)

### API endpoints
- `GET /api/users/:userId` - получение пользователя по ID
- `GET /api/users/by-email?email=...` - поиск пользователя по email
- `POST /api/users` - создание нового пользователя
- `GET /api/users/:userId/subscription` - получение подписки пользователя

### Debug команды
```javascript
// Проверить localStorage
debugAuth.checkStorage()

// Очистить авторизацию
debugAuth.clearAuth()

// Установить тестового пользователя
debugAuth.setTestUser('test@example.com', 'Test User')

// Показать все данные в localStorage
debugAuth.showAllStorage()
```

### Логи для отладки
Все логи имеют префиксы:
- `[App]` - инициализация приложения
- `[AuthContext]` - процесс авторизации
- `[API]` - запросы к API
- `[API Service]` - настройка API сервиса

## Ожидаемое поведение

### ✅ Правильное поведение:
1. Вход в систему → данные сохраняются в localStorage
2. Закрытие сайта → данные остаются в localStorage
3. Открытие сайта → автоматический вход без повторной авторизации
4. При временных сбоях API → пользователь остается авторизованным
5. При удалении пользователя из БД → автоматический выход с очисткой localStorage

### ❌ Неправильное поведение (если сохраняется):
1. После закрытия сайта требуется повторный вход
2. localStorage очищается при временных сетевых ошибках
3. Пользователь видит экран загрузки, но не входит автоматически

## Следующие шаги

Если проблема не решена:
1. Соберите логи из консоли браузера
2. Проверьте Network вкладку на наличие ошибок API
3. Выполните все debug команды и сохраните вывод
4. Опишите проблему с приложением логов

